########################################################################
# MASTER MOBILE PIPELINE â€” SINGLE SYSTEM
# React Native / Kotlin (Gradle) + Detox E2E + Play Store
# Covers: test â†’ uat â†’ production with all gates and notifications.
########################################################################
name: ðŸ“± Mobile Master Pipeline

on:
  push:
    branches: [test, uat, main]
  pull_request:
    branches: [test, uat, main]

env:
  TRIBE_NAME: ${{ vars.TRIBE_NAME }}
  SYSTEM_NAME: ${{ vars.SYSTEM_NAME }}
  APP_NAME: ${{ vars.APP_NAME }}

concurrency:
  group: mobile-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TEST BRANCH
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-mobile:
    name: "[TEST] Run Jest Tests"
    if: github.ref == 'refs/heads/test' || (github.event_name == 'pull_request' && github.base_ref == 'test')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: npm }
      - run: npm ci
      - run: npm test -- --coverage --forceExit
      - uses: actions/upload-artifact@v4
        with:
          name: mobile-coverage-${{ github.run_number }}
          path: coverage/
          retention-days: 30

  sonar-mobile:
    name: "[TEST] SonarCloud Analysis"
    if: github.ref == 'refs/heads/test' || (github.event_name == 'pull_request' && github.base_ref == 'test')
    runs-on: ubuntu-latest
    needs: test-mobile
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=${{ vars.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ vars.SONAR_ORG }}

  quality-gate-mobile:
    name: "[TEST] Quality Gate Approval"
    if: github.ref == 'refs/heads/test' && github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: sonar-mobile
    environment: test-quality-gate
    steps:
      - run: echo "âœ… Mobile quality gate approved"

  gradle-test:
    name: "[TEST] Gradle Build (Debug APK)"
    if: github.ref == 'refs/heads/test' && github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: quality-gate-mobile
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: 17 }
      - uses: android-actions/setup-android@v3
      - run: chmod +x android/gradlew
      - id: version
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
      - working-directory: android
        run: ./gradlew assembleDebug
      - uses: actions/upload-artifact@v4
        with:
          name: debug-apk-${{ github.run_number }}
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30
      - uses: ncipollo/release-action@v1
        with:
          tag: "${{ env.TRIBE_NAME }}-${{ env.SYSTEM_NAME }}-mobile-v${{ steps.version.outputs.VERSION }}-test"
          name: "[${{ env.TRIBE_NAME }}/${{ env.SYSTEM_NAME }}] Mobile Test v${{ steps.version.outputs.VERSION }}"
          artifacts: android/app/build/outputs/apk/debug/app-debug.apk
          prerelease: true
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Register version
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.VERSION_REGISTRY_PAT }}
          repository: ${{ vars.VERSION_REGISTRY_REPO }}
          event-type: register-version
          client-payload: |
            { "tribe": "${{ env.TRIBE_NAME }}", "system": "${{ env.SYSTEM_NAME }}", "repo_type": "mobile",
              "version": "${{ steps.version.outputs.VERSION }}", "environment": "test",
              "run_id": "${{ github.run_id }}", "deployed_by": "${{ github.actor }}" }

  notify-mobile-test:
    name: "[TEST] Notify"
    if: github.ref == 'refs/heads/test' && github.event_name == 'push' && always()
    runs-on: ubuntu-latest
    needs: [gradle-test]
    uses: ./.github/workflows/notify.yml
    with:
      status: ${{ needs.gradle-test.result }}
      pipeline: "${{ vars.TRIBE_NAME }}/${{ vars.SYSTEM_NAME }} Mobile â€“ Test"
      environment: test
      tribe: ${{ vars.TRIBE_NAME }}
      system: ${{ vars.SYSTEM_NAME }}
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # UAT BRANCH
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  gradle-uat:
    name: "[UAT] Gradle Build (Signed Release APK)"
    if: github.ref == 'refs/heads/uat' && github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: 17 }
      - uses: android-actions/setup-android@v3
      - name: Decode keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.keystore
      - run: chmod +x android/gradlew
      - id: version
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
      - working-directory: android
        run: |
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=app/release.keystore \
            -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }}
      - uses: actions/upload-artifact@v4
        with:
          name: uat-apk-${{ github.run_number }}
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 30

  detox-uat:
    name: "[UAT] Detox E2E Tests"
    if: github.ref == 'refs/heads/uat' && github.event_name == 'push'
    runs-on: macos-latest
    needs: gradle-uat
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: npm }
      - run: npm ci
      - run: npm install -g detox-cli
      - run: brew tap wix/brew && brew install applesimutils
      - run: detox test --configuration android.emu.release
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: detox-results-${{ github.run_number }}
          path: artifacts/
          retention-days: 14

  release-apk-uat:
    name: "[UAT] GitHub Pre-Release (APK)"
    if: github.ref == 'refs/heads/uat' && github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: detox-uat
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: uat-apk-${{ github.run_number }}
      - uses: ncipollo/release-action@v1
        with:
          tag: "${{ env.TRIBE_NAME }}-${{ env.SYSTEM_NAME }}-mobile-v${{ needs.gradle-uat.outputs.version }}-uat"
          name: "[${{ env.TRIBE_NAME }}/${{ env.SYSTEM_NAME }}] Mobile UAT v${{ needs.gradle-uat.outputs.version }}"
          artifacts: app-release.apk
          prerelease: true
          token: ${{ secrets.GITHUB_TOKEN }}

  qa-gate-mobile-uat:
    name: "[UAT] QA Developer Approval"
    if: github.ref == 'refs/heads/uat' && github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: release-apk-uat
    environment: uat-qa-gate
    steps:
      - run: echo "âœ… Mobile UAT approved"

  notify-mobile-uat:
    name: "[UAT] Notify"
    if: github.ref == 'refs/heads/uat' && github.event_name == 'push' && always()
    runs-on: ubuntu-latest
    needs: [qa-gate-mobile-uat]
    uses: ./.github/workflows/notify.yml
    with:
      status: ${{ needs.qa-gate-mobile-uat.result }}
      pipeline: "${{ vars.TRIBE_NAME }}/${{ vars.SYSTEM_NAME }} Mobile â€“ UAT"
      environment: uat
      tribe: ${{ vars.TRIBE_NAME }}
      system: ${{ vars.SYSTEM_NAME }}
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PRODUCTION / MAIN BRANCH
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  gradle-prod:
    name: "[PROD] Gradle Build (Release APK + AAB)"
    if: github.ref == 'refs/heads/main' || (github.event_name == 'pull_request' && github.base_ref == 'main')
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: 17 }
      - uses: android-actions/setup-android@v3
      - name: Decode keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.keystore
      - run: chmod +x android/gradlew
      - id: version
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
      - working-directory: android
        run: |
          ./gradlew bundleRelease assembleRelease \
            -Pandroid.injected.signing.store.file=app/release.keystore \
            -Pandroid.injected.signing.store.password=${{ secrets.KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ secrets.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ secrets.KEY_PASSWORD }}
      - uses: actions/upload-artifact@v4
        with:
          name: prod-apk-${{ github.run_number }}
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 90
      - uses: actions/upload-artifact@v4
        with:
          name: prod-aab-${{ github.run_number }}
          path: android/app/build/outputs/bundle/release/app-release.aab
          retention-days: 90

  governance-mobile:
    name: "[PROD] Governance / Change Control"
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: gradle-prod
    environment: governance
    steps:
      - run: echo "âœ… Governance approved"

  release-prod-mobile:
    name: "[PROD] GitHub Release + Play Store"
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: governance-mobile
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: prod-apk-${{ github.run_number }}
      - uses: actions/download-artifact@v4
        with:
          name: prod-aab-${{ github.run_number }}
      - uses: ncipollo/release-action@v1
        with:
          tag: "${{ env.TRIBE_NAME }}-${{ env.SYSTEM_NAME }}-mobile-v${{ needs.gradle-prod.outputs.version }}"
          name: "[${{ env.TRIBE_NAME }}/${{ env.SYSTEM_NAME }}] Mobile Release v${{ needs.gradle-prod.outputs.version }}"
          artifacts: "app-release.apk,app-release.aab"
          makeLatest: true
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload to Google Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ vars.ANDROID_PACKAGE_NAME }}
          releaseFiles: app-release.aab
          track: production
          status: completed
      - name: Register production version
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.VERSION_REGISTRY_PAT }}
          repository: ${{ vars.VERSION_REGISTRY_REPO }}
          event-type: register-version
          client-payload: |
            { "tribe": "${{ env.TRIBE_NAME }}", "system": "${{ env.SYSTEM_NAME }}", "repo_type": "mobile",
              "version": "${{ needs.gradle-prod.outputs.version }}", "environment": "production",
              "run_id": "${{ github.run_id }}", "deployed_by": "${{ github.actor }}" }

  notify-mobile-prod:
    name: "[PROD] Notify"
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && always()
    runs-on: ubuntu-latest
    needs: [release-prod-mobile]
    uses: ./.github/workflows/notify.yml
    with:
      status: ${{ needs.release-prod-mobile.result }}
      pipeline: "${{ vars.TRIBE_NAME }}/${{ vars.SYSTEM_NAME }} Mobile â€“ Production"
      version: ${{ needs.gradle-prod.outputs.version }}
      environment: production
      tribe: ${{ vars.TRIBE_NAME }}
      system: ${{ vars.SYSTEM_NAME }}
    secrets: inherit
